<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>三喵notes</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/gitment.css">
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/diary/" class="header-nav-link" >
                首页
            </a>
            

            
            <a href="/diary/archives" class="header-nav-link">
                归档
            </a>
            

            
            <a href="/diary/tags" class="header-nav-link">
                标签
            </a>
            

            
            <a href="/diary/about/" class="header-nav-link">
                关于
            </a>
            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/diary/" class="mobile-nav-title-link">三喵's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/diary/" class="mobile-nav-link">首页</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/diary/archives" class="mobile-nav-link">归档</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/diary/tags" class="mobile-nav-link">标签</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/diary/about/" class="mobile-nav-link">关于</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">从0到1搭建一套CI/CD流程</h2>
            <div class="post-meta">
                <span class="post-time">2022-03-02</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/diary/categories/%E5%BB%BA%E7%AB%99/">建站</a>
                    
                </span>
                
                <span class="post-visit"> 阅读次数：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88"><span class="toc-text">服务器配置方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%9C%BA%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">构建机的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">docker的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jenkis%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">jenkis的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nexus%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">Nexus的安装</span></a></li></ol></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);">回到顶部</a>
    </div>
</div>
        <div class="post-content">
            <p>以往的的构建部署流程为编写代码、上传代码库、编译压缩为制品、上传到服务器启动。这套流程不仅繁琐，且容易出错，是非常影响开发效率的。为了高效的构建和部署，我们就需要学习<strong>CI/CD</strong>了。</p>
<p><code>CI</code> 的意思是 <code>持续构建</code> 。负责拉取代码库中的代码后，执行用户预置定义好的操作脚本，通过一系列编译操作构建出一个 <code>制品</code> ，并将制品推送至到制品库里面。常用工具有 Gitlab CI，Github CI，Jenkins 等。这个环节不参与部署，只负责构建代码，然后保存构建物。构建物被称为 制品，保存制品的地方被称为 <strong>制品库</strong>。</p>
<p>CD 则有2层含义： <code>持续部署（Continuous Deployment）</code> 和 <code>持续交付（Continuous Delivery）</code> 。 <code>持续交付</code> 的概念是：将制品库的制品拿出后，部署在测试环境 / 交付给客户提前测试。 <code>持续部署</code> 则是将制品部署在生产环境。可以进行持续部署的工具也有很多： <code>Ansible</code> 批量部署， <code>Docker</code> 直接推拉镜像等等。当然也包括我们后面要写到的 <code>Kubernetes</code> 集群部署。</p>
<span id="more"></span>



<h2 id="服务器配置方案"><a href="#服务器配置方案" class="headerlink" title="服务器配置方案"></a>服务器配置方案</h2><p>本次教程记录使用的服务器为购买的二手Dell R720服务器，按照以下表格创建五个虚拟机，每个虚拟机安装的系统都为<strong>Centos7</strong>，<a href="https://link.juejin.cn/?target=https://mirrors.aliyun.com/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">下载地址</a>。大家如果使用云服务器，按照同样的配置购买即可。</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>技术栈</th>
<th>类型</th>
<th>标签</th>
</tr>
</thead>
<tbody><tr>
<td>8核16G</td>
<td>Jenkins + Nexus + Docker</td>
<td>虚拟机</td>
<td>构建机</td>
</tr>
<tr>
<td>8核16G</td>
<td>Kibana</td>
<td>虚拟机</td>
<td>日志收集</td>
</tr>
<tr>
<td>8核16G</td>
<td>Docker + Kubernetes</td>
<td>虚拟机</td>
<td>Kubernetes Master</td>
</tr>
<tr>
<td>4核8G</td>
<td>Docker + Kubernetes</td>
<td>虚拟机</td>
<td>Kubernetes Node</td>
</tr>
<tr>
<td>4核8G</td>
<td>Docker + Kubernetes</td>
<td>虚拟机</td>
<td>Kubernetes Node</td>
</tr>
</tbody></table>
<h2 id="构建机的安装"><a href="#构建机的安装" class="headerlink" title="构建机的安装"></a>构建机的安装</h2><p>本台机器我们安装三个软件，Docker - 服务载体，Jenkins - 构建工具，Nexus - 制品仓库。</p>
<h3 id="docker的安装"><a href="#docker的安装" class="headerlink" title="docker的安装"></a>docker的安装</h3><p>docker贯穿CI/CD中整个流程，作为应用服务的载体有着非常重要的地位。我们可以使用docker将应用打包成一个镜像，交给kubernetes去部署在目标服务集群。并且可以将镜像上传到自己的镜像仓库，做好版本分类处理。</p>
<p>安装方式：添加docker的镜像源，可以加速docker的安装，然后进行yum安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 安装yum扩展包，安装后可以使用yum-config-manager来方便的添加源</span><br><span class="line">yum install yum-utils</span><br><span class="line"></span><br><span class="line"># 增加镜像源</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 安装docker</span><br><span class="line">yum install docker-ce</span><br><span class="line"></span><br><span class="line"># 查看安装版本</span><br><span class="line">$ docker -v</span><br><span class="line">Docker version 20.10.12, build e91ed57</span><br></pre></td></tr></table></figure>

<p>镜像加速器的配置，拉取官方的镜像库的镜像，会比较慢，我们改用国内阿里的镜像库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo cd /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://llu06o1m.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="jenkis的安装"><a href="#jenkis的安装" class="headerlink" title="jenkis的安装"></a>jenkis的安装</h3><p>首先需要安装git，在ci流程中构建机需要去拉取代码，所以必须得安装git。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 安装命令</span><br><span class="line">yum install -y git</span><br><span class="line"></span><br><span class="line"># 查看安装版本</span><br><span class="line">$ git --version</span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure>

<p>因为Jenkins是Java编写的持续构建平台，所以安装Java必不可少。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 安装命令</span><br><span class="line">yum install -y java</span><br><span class="line"></span><br><span class="line"># 查看安装版本</span><br><span class="line">$ java -version</span><br><span class="line">openjdk version &quot;1.8.0_322&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_322-b06)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.322-b06, mixed mode)</span><br></pre></td></tr></table></figure>

<p>由于yum源不自带jenkins的安装源，于是我们需要自己导入一份jenkins安装源进行安装。导入后，使用yum命令安装即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 下载源文件</span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line"># 导入软件源</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line"># 安装jenkins</span><br><span class="line">yum install jenkins</span><br></pre></td></tr></table></figure>

<blockquote><p>rpm适用于所有环境，而yum要有本地yum源才可以使用。yum是上层管理工具，可以自动解决依赖性，而rpm是底层管理工具。</p>
<p>yum是基于rpm包管理，能够从指定的服务器自动下载RPM包并且安装，可以自动处理依赖性关系，并且一次安装所有依赖的软体包，无须繁琐地一次次下载、安装。</p>
</blockquote> 

<p>jenkins安装成功后，会将启动命令注册到系统systemd命令中。我们可以直接通过systemctl操作jenkins。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动</span><br><span class="line">systemctl start jenkins</span><br><span class="line"># 重启</span><br><span class="line">systemctl restart jenkins</span><br><span class="line"># 停止</span><br><span class="line">systemctl restart jenkins</span><br></pre></td></tr></table></figure>

<p>在启动前，先进行防火墙设置，放开8080端口的访问。因为jenkins启动默认的端口为8080，需要修改在**/etc/sysconfig/jenkins<strong>配置文件中的</strong>JENKINS_PORT**，我们这里使用默认的8080。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加开放端口</span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line"># 重新加载配置</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"># 查看开放端口列表</span><br><span class="line">firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<p>启动完成后，我们使用<strong>IP:8080</strong>来进行访问，我们可以看到解锁jenkins界面，执行下面的命令，获取密码，输入密码后确定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/lib/jenkins/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>

<p>下一步我们需要安装插件，我们选推荐的插件，后续需要其他插件再去安装，安装完插件，注册个账号即完成了安装。</p>
<p>我们要使用jenkins操作docker，需要进行权限设定，否则用不了。docker提供了一个用户组的概念。我们可以将执行Shell的用户添加到名称为docker的用户组，则可以正常执行docker命令。设置好后我们重启jenkins，就可以试试创建流水线脚本使用docker。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 将当前用户添加至docker用户组</span><br><span class="line">gpasswd -a jenkins docker</span><br><span class="line"></span><br><span class="line"># 更新docker用户组</span><br><span class="line">newgrp docker</span><br><span class="line"></span><br><span class="line"># 重启jenkins</span><br><span class="line">systemctl restart jenkins</span><br></pre></td></tr></table></figure>

<h3 id="Nexus的安装"><a href="#Nexus的安装" class="headerlink" title="Nexus的安装"></a>Nexus的安装</h3><p>镜像库就是集中存放镜像的一个文件服务。镜像库在CI/CD中，又称制品库。构建后的产物称为制品，制品则要放到制品库做中转和版本管理。常用平台有Nexus，Jfrog，Harbor或其他对象存储平台。</p>
<p>在这里，我们选用Nexus3作为自己的镜像库。因为其稳定，性能好，免费，部署方便，且支持类型多，是许多制品库的首选选型。</p>

        </div>
        
        <div class="post-tag">
            
            <a class="tag" href="/diary/tags/docker/" title="docker">docker</a>
            
            <a class="tag" href="/diary/tags/jenkins/" title="jenkins">jenkins</a>
            
            <a class="tag" href="/diary/tags/linux/" title="linux">linux</a>
            
        </div>
        
    </article>
</div>
<div class="paginator">
    
        
        
            <a class="next" href="/diary/%E5%9F%BA%E4%BA%8Ehexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.html">
                <span class="nav-default">基于hexo搭建个人博客</span>
                <span class="nav-mobile">下一篇</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>
<div id="comment-container"></div>
    </div>
</div>
<footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
                2021 -
            
            2022
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/sanmiaohub">三喵</a>
        </p>
    </div>
</footer>
</body>

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type='text/javascript' src='/js/myjs.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
    
    var gitalk = new Gitalk({
        clientID: 'ac5bcf4f0c99189ff836',
        clientSecret: '35001628275065c8216c7dac9cdff00ddcda1c88',
        repo: 'diary',
        owner: 'sanmiaohub',
        admin: ['sanmiaohub'],
        id: decodeURI(location.pathname),
        distractionFreeMode: false
    });

    gitalk.render('comment-container');
    

</script>
</html>
